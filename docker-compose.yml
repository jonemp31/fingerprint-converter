version: "3.8"

services:
  fingerprint-converter:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fingerprint-converter
    restart: always
    ports:
      - "5001:5001"
    environment:
      # Server Configuration
      PORT: 5001
      APP_ENV: production
      READ_TIMEOUT: 5m
      WRITE_TIMEOUT: 5m
      BODY_LIMIT: 524288000  # 500MB
      
      # Performance Tuning
      GOMEMLIMIT: 2GiB
      GOGC: 100
      MAX_WORKERS: 64
      BUFFER_POOL_SIZE: 100
      BUFFER_SIZE: 10485760  # 10MB
      REQUEST_TIMEOUT: 5m
      DOWNLOAD_TIMEOUT: 30s
      MAX_DOWNLOAD_SIZE: 524288000  # 500MB
      
      # Cache Configuration
      CACHE_DIR: /tmp/media-cache
      CACHE_TTL: 28m  # Cache expires at 28 minutes
      FILE_TTL: 30m   # File deleted at 30 minutes
      ENABLE_CACHE: "true"
      
      # Anti-Fingerprint Settings
      DEFAULT_AF_LEVEL: moderate  # none/basic/moderate/paranoid
      
      # Logging
      LOG_LEVEL: info
      ENABLE_PERFORMANCE_LOGS: "true"
      DEBUG: "false"
      
      # Production Settings
      PRODUCTION_MODE: "true"
      ENABLE_CORS: "true"
      
      # Monitoring
      ENABLE_HEALTH_CHECK: "true"
      ENABLE_STATS_ENDPOINT: "true"

    # Use tmpfs for high-performance temporary file storage
    tmpfs:
      - /tmp/media-cache:size=4G,mode=1777

    networks:
      - network_swarm_public

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '2'
          memory: 2G

networks:
  network_swarm_public:
    external: true
